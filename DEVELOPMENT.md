# å›½æ¼«è¿½æ›´ç³»ç»Ÿ - å¼€å‘æ–‡æ¡£

> é¡¹ç›®ç‰ˆæœ¬: 1.0.0
> æœ€åæ›´æ–°: 2025å¹´2æœˆ
> æŠ€æœ¯æ ˆ: Python 3.11 + Flask 3.0 + SQLite

---

## ç›®å½•

- [1. é¡¹ç›®æ¦‚è¿°](#1-é¡¹ç›®æ¦‚è¿°)
- [2. æ¶æ„è®¾è®¡](#2-æ¶æ„è®¾è®¡)
- [3. ç¯å¢ƒé…ç½®](#3-ç¯å¢ƒé…ç½®)
- [4. å¼€å‘æŒ‡å—](#4-å¼€å‘æŒ‡å—)
- [5. API æ–‡æ¡£](#5-api-æ–‡æ¡£)
- [6. éƒ¨ç½²ä¸è¿ç»´](#6-éƒ¨ç½²ä¸è¿ç»´)
- [7. æµ‹è¯•è¯´æ˜](#7-æµ‹è¯•è¯´æ˜)
- [8. ç»´æŠ¤é¡»çŸ¥](#8-ç»´æŠ¤é¡»çŸ¥)

---

## 1. é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®ç®€ä»‹

å›½æ¼«è¿½æ›´ç³»ç»Ÿæ˜¯ä¸€ä¸ªè‡ªéƒ¨ç½²çš„åŠ¨æ¼«è¿½æ›´ç®¡ç†å¹³å°ï¼Œä¸“ä¸ºå›½æ¼«çˆ±å¥½è€…è®¾è®¡ã€‚ç³»ç»Ÿé›†æˆäº† TMDB åŠ¨æ¼«æ•°æ®æºå’Œ Invidious è§†é¢‘æœç´¢åŠŸèƒ½ï¼Œæä¾›æ™ºèƒ½æ¨¡ç³ŠåŒ¹é…ã€è‡ªåŠ¨è¿‡æ»¤åˆé›†ã€å®šæ—¶åŒæ­¥æ›´æ–°ç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚

### 1.2 æ ¸å¿ƒç‰¹æ€§

| ç‰¹æ€§ | æè¿° |
|------|------|
| ğŸ” TMDB é›†æˆ | æ”¯æŒä» TMDB è‡ªåŠ¨è·å–åŠ¨æ¼«ä¿¡æ¯ã€æµ·æŠ¥ã€é›†æ•°æ•°æ® |
| ğŸ¬ è§†é¢‘æºæœç´¢ | é€šè¿‡ Invidious API æœç´¢ YouTube ä¸Šçš„å›½æ¼«è§†é¢‘æº |
| ğŸ§  æ™ºèƒ½åŒ¹é… | å¤šé‡åŒ¹é…ç®—æ³•ï¼ˆç¼–è¾‘è·ç¦»ã€N-gramã€ç²¾ç¡®åŒ¹é…ï¼‰+ å›½æ¼«åˆ«ååº“ |
| ğŸš« åˆé›†è¿‡æ»¤ | è‡ªåŠ¨è¯†åˆ«å¹¶è¿‡æ»¤åˆé›†/å‰ªè¾‘/è§£è¯´ç­‰éæ­£ç‰‡å†…å®¹ |
| â° è‡ªåŠ¨åŒæ­¥ | æ”¯æŒå…¨å±€å’Œä¸ªåˆ«åŠ¨æ¼«çš„ç‹¬ç«‹åŒæ­¥é—´éš”è®¾ç½® |
| ğŸ“Š è¿›åº¦ç®¡ç† | è¿½è¸ªè§‚çœ‹è¿›åº¦ï¼Œæ ‡è®°å·²çœ‹/æœªçœ‹çŠ¶æ€ |
| ğŸ¨ ç°ä»£åŒ– UI | æ·±è‰²ä¸»é¢˜ã€å“åº”å¼è®¾è®¡ã€ç§»åŠ¨ç«¯å‹å¥½ |

### 1.3 æŠ€æœ¯æ ˆ

#### åç«¯
- **Python 3.11** - ä¸»è¦ç¼–ç¨‹è¯­è¨€
- **Flask 3.0.0** - Web æ¡†æ¶
- **SQLite** - åµŒå…¥å¼æ•°æ®åº“
- **APScheduler 3.10.4** - å®šæ—¶ä»»åŠ¡è°ƒåº¦
- **requests 2.31.0** - HTTP è¯·æ±‚åº“

#### å‰ç«¯
- **HTML5/CSS3/JavaScript** - åŸç”Ÿå‰ç«¯æŠ€æœ¯
- **CSS å˜é‡** - ä¸»é¢˜ç³»ç»Ÿ
- **å“åº”å¼è®¾è®¡** - ç§»åŠ¨ç«¯é€‚é…

#### å¤–éƒ¨æœåŠ¡
- **TMDB API** - åŠ¨æ¼«å…ƒæ•°æ®
- **Invidious API** - YouTube é•œåƒæœç´¢

#### éƒ¨ç½²
- **Docker & Docker Compose** - å®¹å™¨åŒ–éƒ¨ç½²

### 1.4 é¡¹ç›®ç»“æ„

```
anime-tracker/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py              # åº”ç”¨å…¥å£
â”‚   â”œâ”€â”€ config.py            # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ api/                 # API è·¯ç”±
â”‚   â”‚   â””â”€â”€ routes.py
â”‚   â”œâ”€â”€ core/                # æ ¸å¿ƒä¸šåŠ¡æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ tmdb_client.py        # TMDB API å®¢æˆ·ç«¯
â”‚   â”‚   â”œâ”€â”€ invidious_client.py   # Invidious API å®¢æˆ·ç«¯
â”‚   â”‚   â”œâ”€â”€ source_finder.py      # è§†é¢‘æºæŸ¥æ‰¾å™¨
â”‚   â”‚   â”œâ”€â”€ link_converter.py     # é“¾æ¥è½¬æ¢å™¨
â”‚   â”‚   â”œâ”€â”€ scheduler.py          # ä»»åŠ¡è°ƒåº¦å™¨
â”‚   â”‚   â””â”€â”€ matcher/              # åŒ¹é…ç®—æ³•å­æ¨¡å—
â”‚   â”‚       â”œâ”€â”€ collection_filter.py
â”‚   â”‚       â”œâ”€â”€ fuzzy_matcher.py
â”‚   â”‚       â”œâ”€â”€ preprocessor.py
â”‚   â”‚       â””â”€â”€ scorer.py
â”‚   â”œâ”€â”€ db/                  # æ•°æ®åº“æ¨¡å—
â”‚   â”‚   â””â”€â”€ database.py
â”‚   â””â”€â”€ web/                 # Web å‰ç«¯
â”‚       â”œâ”€â”€ static/
â”‚       â”‚   â”œâ”€â”€ app.js
â”‚       â”‚   â””â”€â”€ theme.css
â”‚       â””â”€â”€ templates/
â”‚           â”œâ”€â”€ base.html
â”‚           â”œâ”€â”€ index.html
â”‚           â”œâ”€â”€ anime_detail.html
â”‚           â”œâ”€â”€ sources_modal.html
â”‚           â””â”€â”€ settings.html
â”œâ”€â”€ data/                    # æ•°æ®å­˜å‚¨ç›®å½•
â”‚   â””â”€â”€ tracker.db
â”œâ”€â”€ .env                     # ç¯å¢ƒå˜é‡é…ç½®
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ requirements.txt
â””â”€â”€ README.md
```

---

## 2. æ¶æ„è®¾è®¡

### 2.1 ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç”¨æˆ·æµè§ˆå™¨                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚ HTTP/JSON
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Flask Web åº”ç”¨                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Web è“å›¾   â”‚  â”‚  API è“å›¾   â”‚  â”‚    å®šæ—¶è°ƒåº¦å™¨            â”‚  â”‚
â”‚  â”‚  (é¡µé¢è·¯ç”±) â”‚  â”‚  (API æ¥å£) â”‚  â”‚  (APScheduler)          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                â”‚                      â”‚                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                   ä¸šåŠ¡é€»è¾‘å±‚                             â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚ TMDB     â”‚ â”‚Invidious â”‚ â”‚ Source   â”‚ â”‚  Link    â”‚  â”‚    â”‚
â”‚  â”‚  â”‚ Client   â”‚ â”‚ Client   â”‚ â”‚ Finder   â”‚ â”‚Converter â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚           åŒ¹é…å¼•æ“ (Matcher)                      â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â€¢ æ¨¡ç³ŠåŒ¹é…  â€¢ é›†æ•°æ£€æµ‹  â€¢ åˆé›†è¿‡æ»¤  â€¢ è¯„åˆ†     â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      SQLite æ•°æ®åº“                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  animes â”‚ episodes â”‚ sources â”‚ settings â”‚ sync_logs â”‚ ...      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å¤–éƒ¨æœåŠ¡                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  TMDB API          â”‚         Invidious API                      â”‚
â”‚  (åŠ¨æ¼«å…ƒæ•°æ®)      â”‚         (YouTube é•œåƒæœç´¢)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ•°æ®åº“è®¾è®¡

#### æ ¸å¿ƒæ•°æ®è¡¨

| è¡¨å | ç”¨é€” | ä¸»è¦å­—æ®µ |
|------|------|----------|
| `animes` | åŠ¨æ¼«åŸºæœ¬ä¿¡æ¯ | id, tmdb_id, title_cn, total_episodes, watched_ep, status |
| `episodes` | é›†æ•°ä¿¡æ¯ | id, anime_id, absolute_num, title, air_date, watched |
| `sources` | è§†é¢‘æº | id, episode_id, video_id, channel_id, match_score, is_valid |
| `custom_aliases` | è‡ªå®šä¹‰åˆ«å | id, anime_id, alias |
| `anime_source_rules` | æœç´¢è§„åˆ™ | anime_id, allow_keywords, deny_keywords, allow_channels, deny_channels |
| `settings` | å…¨å±€è®¾ç½® | key, value |
| `sync_logs` | åŒæ­¥æ—¥å¿— | id, anime_id, sync_type, episodes_synced, status |
| `trusted_channels` | ä¿¡ä»»é¢‘é“ | id, channel_id, channel_name, priority |

#### ER å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   animes    â”‚â”€â”€â”€â”€â”€â”€<â”‚  episodes   â”‚â”€â”€â”€â”€â”€â”€<â”‚  sources    â”‚
â”‚             â”‚  1:N  â”‚             â”‚  1:N  â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                     â”‚
       â”‚                     â”‚
       v                     v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚custom_alias â”‚       â”‚source_rules â”‚
â”‚             â”‚       â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 æ ¸å¿ƒæ¨¡å—è¯´æ˜

#### 2.3.1 TMDB å®¢æˆ·ç«¯ (`tmdb_client.py`)

è´Ÿè´£ä¸ TMDB API äº¤äº’ï¼Œè·å–åŠ¨æ¼«æ•°æ®ï¼š

- `search_anime(query)` - æœç´¢åŠ¨æ¼«
- `get_anime_detail(tmdb_id)` - è·å–åŠ¨æ¼«è¯¦æƒ…
- `get_all_episodes(tmdb_id, seasons)` - è·å–æ‰€æœ‰é›†æ•°

#### 2.3.2 Invidious å®¢æˆ·ç«¯ (`invidious_client.py`)

é€šè¿‡ Invidious å®ä¾‹æœç´¢ YouTube è§†é¢‘ï¼š

- `search_videos(query)` - æœç´¢è§†é¢‘
- `get_video_info(video_id)` - è·å–è§†é¢‘è¯¦æƒ…

#### 2.3.3 è§†é¢‘æºæŸ¥æ‰¾å™¨ (`source_finder.py`)

æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼Œè´Ÿè´£æŸ¥æ‰¾å’ŒåŒ¹é…è§†é¢‘æºï¼š

```
find_sources_for_episode()
    â”‚
    â”œâ”€> æ£€æŸ¥ç¼“å­˜
    â”œâ”€> ç”Ÿæˆæœç´¢å…³é”®è¯
    â”œâ”€> è°ƒç”¨ Invidious æœç´¢
    â”œâ”€> è¯„åˆ†è¿‡æ»¤
    â””â”€> ä¿å­˜åˆ°æ•°æ®åº“
```

#### 2.3.4 åŒ¹é…å¼•æ“ (`matcher/`)

æ™ºèƒ½åŒ¹é…ç®—æ³•å­æ¨¡å—ï¼š

| æ¨¡å— | åŠŸèƒ½ |
|------|------|
| `preprocessor.py` | æ–‡æœ¬é¢„å¤„ç†ï¼ˆç¹ç®€è½¬æ¢ã€åŒéŸ³å­—æ›¿æ¢ï¼‰ |
| `fuzzy_matcher.py` | æ¨¡ç³ŠåŒ¹é…ç®—æ³•ï¼ˆç¼–è¾‘è·ç¦»ã€N-gramï¼‰ |
| `collection_filter.py` | åˆé›†æ£€æµ‹ä¸è¿‡æ»¤ |
| `scorer.py` | ç»¼åˆè¯„åˆ†ç³»ç»Ÿ |

#### 2.3.5 ä»»åŠ¡è°ƒåº¦å™¨ (`scheduler.py`)

è‡ªåŠ¨åŒæ­¥è°ƒåº¦ï¼š

- `check_and_sync()` - æ£€æŸ¥å¹¶åŒæ­¥éœ€è¦æ›´æ–°çš„åŠ¨æ¼«
- æ”¯æŒå…¨å±€å’Œä¸ªåˆ«åŠ¨æ¼«ç‹¬ç«‹åŒæ­¥é—´éš”
- è‡ªåŠ¨æ¸…ç†è¿‡æœŸæ—¥å¿—

---

## 3. ç¯å¢ƒé…ç½®

### 3.1 ç³»ç»Ÿè¦æ±‚

| ç»„ä»¶ | æœ€ä½è¦æ±‚ | æ¨èé…ç½® |
|------|----------|----------|
| æ“ä½œç³»ç»Ÿ | Linux/macOS/Windows | Linux (Ubuntu 22.04+) |
| Python | 3.11+ | 3.11 |
| å†…å­˜ | 512 MB | 1 GB+ |
| ç£ç›˜ | 500 MB | 2 GB+ |
| Docker | 20.10+ | æœ€æ–°ç‰ˆ |

### 3.2 æœ¬åœ°å¼€å‘ç¯å¢ƒ

#### æ­¥éª¤ 1: å…‹éš†é¡¹ç›®

```bash
git clone <repository-url>
cd anime-tracker
```

#### æ­¥éª¤ 2: åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ

```bash
python -m venv venv
source venv/bin/activate  # Linux/macOS
# æˆ–
venv\Scripts\activate     # Windows
```

#### æ­¥éª¤ 3: å®‰è£…ä¾èµ–

```bash
pip install -r requirements.txt
```

#### æ­¥éª¤ 4: é…ç½®ç¯å¢ƒå˜é‡

åˆ›å»º `.env` æ–‡ä»¶ï¼š

```bash
# TMDB é…ç½®
TMDB_API_KEY=your_tmdb_api_key_here

# Invidious é…ç½®
INVIDIOUS_URL=https://invidious.example.com

# æ•°æ®åº“é…ç½®
DATABASE_PATH=./data/tracker.db

# æ—¶åŒº
TZ=Asia/Shanghai

# æ—¥å¿—çº§åˆ« (DEBUG, INFO, WARNING, ERROR)
LOG_LEVEL=INFO
```

#### æ­¥éª¤ 5: åˆå§‹åŒ–æ•°æ®åº“

```bash
python -c "from app.db.database import init_db; init_db()"
```

#### æ­¥éª¤ 6: å¯åŠ¨åº”ç”¨

```bash
python -m app.main
```

è®¿é—® http://localhost:8000

### 3.3 Docker éƒ¨ç½²

#### ä½¿ç”¨ Docker Composeï¼ˆæ¨èï¼‰

```bash
# 1. é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶

# 2. æ„å»ºå¹¶å¯åŠ¨
docker-compose up -d --build

# 3. æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f

# 4. åœæ­¢æœåŠ¡
docker-compose down
```

#### ä½¿ç”¨ Docker å•ç‹¬è¿è¡Œ

```bash
# æ„å»ºé•œåƒ
docker build -t anime-tracker .

# è¿è¡Œå®¹å™¨
docker run -d \
  --name anime-tracker \
  -p 8180:8000 \
  -v $(pwd)/data:/app/data \
  -e TMDB_API_KEY=your_key \
  -e INVIDIOUS_URL=https://invidious.example.com \
  anime-tracker
```

### 3.4 é…ç½®é¡¹è¯¦è§£

#### TMDB API

ç”³è¯·åœ°å€: https://www.themoviedb.org/settings/api

```
TMDB_API_KEY         # å¿…éœ€ï¼ŒTMDB API å¯†é’¥
TMDB_BASE_URL        # é»˜è®¤: https://api.themoviedb.org/3
TMDB_LANGUAGE        # é»˜è®¤: zh-CN
```

#### Invidious å®ä¾‹

å…¬å…±å®ä¾‹åˆ—è¡¨: https://docs.invidious.io/instances/

```
INVIDIOUS_URL               # å¿…éœ€ï¼ŒInvidious å®ä¾‹åœ°å€
INVIDIOUS_API_TIMEOUT       # é»˜è®¤: 30 ç§’
```

#### åŒ¹é…ç®—æ³•å‚æ•°

```python
# åŒ¹é…é˜ˆå€¼
MATCH_THRESHOLD             # é»˜è®¤: 50ï¼Œæœ€ä½åŒ¹é…åˆ†æ•°
MATCH_RECOMMEND_THRESHOLD   # é»˜è®¤: 70ï¼Œæ¨èåŒ¹é…åˆ†æ•°

# æœç´¢å‚æ•°
MAX_SEARCH_RESULTS          # é»˜è®¤: 50ï¼Œæœ€å¤§æœç´¢ç»“æœæ•°
SEARCH_KEYWORDS_LIMIT       # é»˜è®¤: 5ï¼Œæœ€å¤šæœç´¢å…³é”®è¯æ•°

# æ¨¡ç³ŠåŒ¹é…
FUZZY_EDIT_DISTANCE_MAX     # é»˜è®¤: 2ï¼Œæœ€å¤§ç¼–è¾‘è·ç¦»
FUZZY_NGRAM_SIZE            # é»˜è®¤: 2ï¼ŒN-gram å¤§å°
FUZZY_MIN_SIMILARITY        # é»˜è®¤: 0.6ï¼Œæœ€å°ç›¸ä¼¼åº¦

# åˆé›†è¿‡æ»¤
COLLECTION_MAX_DURATION     # é»˜è®¤: 3600 ç§’ï¼Œåˆé›†æœ€å¤§æ—¶é•¿
```

---

## 4. å¼€å‘æŒ‡å—

### 4.1 å¼€å‘è§„èŒƒ

#### ä»£ç é£æ ¼

- éµå¾ª PEP 8 è§„èŒƒ
- ä½¿ç”¨ç±»å‹æ³¨è§£
- å‡½æ•°æ·»åŠ  docstring
- å˜é‡å‘½åä½¿ç”¨ snake_case

```python
def find_sources_for_episode(anime_id: int, episode_num: int) -> List[Dict[str, Any]]:
    """
    æŸ¥æ‰¾æŒ‡å®šé›†æ•°çš„è§†é¢‘æº

    Args:
        anime_id: åŠ¨æ¼« ID
        episode_num: é›†æ•°

    Returns:
        è§†é¢‘æºåˆ—è¡¨
    """
    ...
```

#### é”™è¯¯å¤„ç†

```python
try:
    result = some_operation()
except SpecificException as e:
    logger.error(f"Operation failed: {e}")
    raise
except Exception as e:
    logger.exception("Unexpected error")
    raise
```

### 4.2 æ·»åŠ æ–°åŠŸèƒ½

#### æ·»åŠ æ–°çš„ API ç«¯ç‚¹

åœ¨ `app/api/routes.py` ä¸­æ·»åŠ ï¼š

```python
@api.route('/new_endpoint', methods=['POST'])
def new_endpoint():
    data = request.json or {}
    # å¤„ç†é€»è¾‘
    return jsonify({'success': True})
```

#### æ·»åŠ æ–°çš„é…ç½®é¡¹

åœ¨ `app/config.py` ä¸­æ·»åŠ ï¼š

```python
NEW_CONFIG = os.getenv("NEW_CONFIG", "default_value")
```

#### æ·»åŠ æ–°çš„æ•°æ®è¡¨

åœ¨ `app/db/database.py` çš„ `init_db()` å‡½æ•°ä¸­æ·»åŠ ï¼š

```python
c.execute('''CREATE TABLE IF NOT EXISTS new_table (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    field_name TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)''')
```

### 4.3 å¸¸è§ä»»åŠ¡

#### æ·»åŠ æ–°çš„å›½æ¼«åˆ«å

ç¼–è¾‘ `app/config.py`ï¼š

```python
DONGHUA_ALIASES = {
    "åŠ¨æ¼«åç§°": ["åˆ«å1", "åˆ«å2", "English Name"],
    # æ·»åŠ æ–°åˆ«å...
}
```

#### æ·»åŠ é»‘åå•å…³é”®è¯

ç¼–è¾‘ `app/config.py`ï¼š

```python
EXCLUDE_KEYWORDS = [
    'é¢„å‘Š', 'PV', 'CM',
    'ä½ çš„æ–°å…³é”®è¯',
    # ...
]
```

#### è°ƒè¯•åŒ¹é…ç®—æ³•

å¯ç”¨è°ƒè¯•æ—¥å¿—ï¼š

```bash
# .env
LOG_LEVEL=DEBUG
```

æŸ¥çœ‹åŒ¹é…åˆ†æ•°ï¼š

```python
logger.debug(f"Match score: {score_result}")
```

### 4.4 æµ‹è¯•

#### æ‰‹åŠ¨æµ‹è¯•

```bash
# æµ‹è¯• TMDB æœç´¢
curl "http://localhost:8000/api/search?q=æ–—ç ´è‹ç©¹"

# æµ‹è¯•æ·»åŠ åŠ¨æ¼«
curl -X POST "http://localhost:8000/api/anime/add" \
  -H "Content-Type: application/json" \
  -d '{"tmdb_id": 12345}'

# æµ‹è¯•åŒæ­¥
curl -X POST "http://localhost:8000/api/anime/1/sync"
```

---

## 5. API æ–‡æ¡£

### 5.1 æ¦‚è¿°

- **åŸºç¡€ URL**: `http://localhost:8180`
- **æ•°æ®æ ¼å¼**: JSON
- **å­—ç¬¦ç¼–ç **: UTF-8

### 5.2 Web è·¯ç”±

| è·¯ç”± | æ–¹æ³• | æè¿° |
|------|------|------|
| `/` | GET | é¦–é¡µ - åŠ¨æ¼«åˆ—è¡¨ |
| `/anime/<id>` | GET | åŠ¨æ¼«è¯¦æƒ…é¡µ |
| `/anime/<id>/episode/<num>/sources` | GET | è§†é¢‘æºæ¨¡æ€æ¡† |
| `/settings` | GET | è®¾ç½®é¡µé¢ |

### 5.3 API ç«¯ç‚¹

#### 5.3.1 æœç´¢åŠ¨æ¼«

```http
GET /api/search?q={query}
```

**è¯·æ±‚å‚æ•°:**

| å‚æ•° | ç±»å‹ | å¿…éœ€ | æè¿° |
|------|------|------|------|
| q | string | æ˜¯ | æœç´¢å…³é”®è¯ |

**å“åº”ç¤ºä¾‹:**

```json
[
  {
    "tmdb_id": 94605,
    "title_cn": "æ–—ç ´è‹ç©¹",
    "title_en": "Fighter of the Destiny",
    "poster_url": "https://...",
    "overview": "...",
    "air_date": "2017-01-01",
    "total_episodes": 24
  }
]
```

#### 5.3.2 æ·»åŠ åŠ¨æ¼«

```http
POST /api/anime/add
```

**è¯·æ±‚ä½“:**

```json
{
  "tmdb_id": 94605
}
```

**å“åº”ç¤ºä¾‹:**

```json
{
  "success": true,
  "anime_id": 1
}
```

#### 5.3.3 æ‰‹åŠ¨æ·»åŠ åŠ¨æ¼«

```http
POST /api/anime/add_manual
```

**è¯·æ±‚ä½“:**

```json
{
  "title": "åŠ¨æ¼«åç§°",
  "total_episodes": 24,
  "aliases": ["åˆ«å1", "åˆ«å2"],
  "poster_url": "https://...",
  "status": "Returning Series"
}
```

#### 5.3.4 æ ‡è®°å·²çœ‹

```http
POST /api/anime/{anime_id}/episode/{ep_num}/watch
```

**å“åº”ç¤ºä¾‹:**

```json
{
  "success": true
}
```

#### 5.3.5 æ›´æ–°è¿›åº¦

```http
PUT /api/anime/{anime_id}/progress
```

**è¯·æ±‚ä½“:**

```json
{
  "watched_ep": 12
}
```

#### 5.3.6 åŒæ­¥åŠ¨æ¼«è§†é¢‘æº

```http
POST /api/anime/{anime_id}/sync
```

**å“åº”ç¤ºä¾‹:**

```json
{
  "success": true,
  "synced_episodes": 5
}
```

#### 5.3.7 è·å–è®¾ç½®

```http
GET /api/settings
```

**å“åº”ç¤ºä¾‹:**

```json
{
  "auto_sync_enabled": "true",
  "auto_sync_interval": "360"
}
```

#### 5.3.8 æ›´æ–°è®¾ç½®

```http
PUT /api/settings
```

**è¯·æ±‚ä½“:**

```json
{
  "auto_sync_enabled": "true",
  "auto_sync_interval": "360"
}
```

#### 5.3.9 æ›´æ–°åŠ¨æ¼«æœç´¢è§„åˆ™

```http
PUT /api/anime/{anime_id}/rules
```

**è¯·æ±‚ä½“:**

```json
{
  "allow_keywords": ["å®˜æ–¹", "æ­£ç‰ˆ"],
  "deny_keywords": ["å‰ªè¾‘", "è§£è¯´"],
  "allow_channels": ["UC_xxx"],
  "deny_channels": ["UC_yyy"]
}
```

### 5.4 é”™è¯¯å“åº”

```json
{
  "error": "é”™è¯¯æè¿°ä¿¡æ¯"
}
```

| HTTP çŠ¶æ€ç  | æè¿° |
|-------------|------|
| 200 | æˆåŠŸ |
| 400 | è¯·æ±‚å‚æ•°é”™è¯¯ |
| 404 | èµ„æºä¸å­˜åœ¨ |
| 500 | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ |

---

## 6. éƒ¨ç½²ä¸è¿ç»´

### 6.1 ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

#### ä½¿ç”¨ Nginx åå‘ä»£ç†

```nginx
server {
    listen 80;
    server_name anime.example.com;

    location / {
        proxy_pass http://localhost:8180;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

#### ä½¿ç”¨ HTTPSï¼ˆLet's Encryptï¼‰

```bash
# å®‰è£… certbot
sudo apt-get install certbot python3-certbot-nginx

# è·å–è¯ä¹¦
sudo certbot --nginx -d anime.example.com
```

### 6.2 ç›‘æ§ä¸æ—¥å¿—

#### æŸ¥çœ‹åº”ç”¨æ—¥å¿—

```bash
# Docker ç¯å¢ƒ
docker-compose logs -f anime-tracker

# æŸ¥çœ‹æœ€è¿‘ 100 è¡Œ
docker-compose logs --tail=100 anime-tracker
```

#### æ—¥å¿—çº§åˆ«é…ç½®

```
LOG_LEVEL=DEBUG    # è¯¦ç»†è°ƒè¯•ä¿¡æ¯
LOG_LEVEL=INFO     # ä¸€èˆ¬ä¿¡æ¯ï¼ˆé»˜è®¤ï¼‰
LOG_LEVEL=WARNING  # è­¦å‘Šä¿¡æ¯
LOG_LEVEL=ERROR    # ä»…é”™è¯¯ä¿¡æ¯
```

### 6.3 æ•°æ®å¤‡ä»½

#### å¤‡ä»½æ•°æ®åº“

```bash
# åœæ­¢æœåŠ¡
docker-compose down

# å¤‡ä»½æ•°æ®ç›®å½•
tar -czf backup-$(date +%Y%m%d).tar.gz data/

# æˆ–ä½¿ç”¨ sqlite3 å¤‡ä»½
sqlite3 data/tracker.db ".backup data/backup-$(date +%Y%m%d).db"

# é‡å¯æœåŠ¡
docker-compose up -d
```

#### æ¢å¤æ•°æ®åº“

```bash
# åœæ­¢æœåŠ¡
docker-compose down

# æ¢å¤æ•°æ®
tar -xzf backup-20240101.tar.gz

# é‡å¯æœåŠ¡
docker-compose up -d
```

### 6.4 æ€§èƒ½ä¼˜åŒ–

#### æ•°æ®åº“ä¼˜åŒ–

```bash
# å®šæœŸæ¸…ç†è¿‡æœŸè§†é¢‘æº
sqlite3 data/tracker.db "DELETE FROM sources WHERE created_at < datetime('now', '-30 days');"

# æ¸…ç†æ—§åŒæ­¥æ—¥å¿—
sqlite3 data/tracker.db "DELETE FROM sync_logs WHERE created_at < datetime('now', '-90 days');"

# VACUUM æ•°æ®åº“
sqlite3 data/tracker.db "VACUUM;"
```

#### ç¼“å­˜ç­–ç•¥

- è§†é¢‘æºç¼“å­˜ 7 å¤©
- TMDB æ•°æ®æ°¸ä¹…ç¼“å­˜
- åŒæ­¥ç»“æœç¼“å­˜åˆ°ä¸‹æ¬¡åŒæ­¥

### 6.5 æ•…éšœæ’æŸ¥

#### å¸¸è§é—®é¢˜

| é—®é¢˜ | å¯èƒ½åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|----------|----------|
| æ— æ³•è¿æ¥ TMDB | API Key æ— æ•ˆ | æ£€æŸ¥ `TMDB_API_KEY` |
| è§†é¢‘æœç´¢å¤±è´¥ | Invidious å®ä¾‹ä¸å¯ç”¨ | æ›´æ¢ `INVIDIOUS_URL` |
| åŒæ­¥ä¸å·¥ä½œ | å®šæ—¶ä»»åŠ¡æœªå¯åŠ¨ | æ£€æŸ¥ `auto_sync_enabled` |
| åŒ¹é…ä¸å‡†ç¡® | åˆ«åç¼ºå¤± | æ·»åŠ è‡ªå®šä¹‰åˆ«å |

#### è°ƒè¯•å‘½ä»¤

```bash
# æ£€æŸ¥é…ç½®
docker-compose config

# è¿›å…¥å®¹å™¨
docker-compose exec anime-tracker bash

# æµ‹è¯•æ•°æ®åº“
docker-compose exec anime-tracker sqlite3 /app/data/tracker.db "SELECT COUNT(*) FROM animes;"
```

---

## 7. æµ‹è¯•è¯´æ˜

### 7.1 åŠŸèƒ½æµ‹è¯•æ¸…å•

| åŠŸèƒ½ | æµ‹è¯•æ–¹æ³• | é¢„æœŸç»“æœ |
|------|----------|----------|
| æœç´¢åŠ¨æ¼« | è¾“å…¥å…³é”®è¯æœç´¢ | è¿”å›ç›¸å…³åŠ¨æ¼«åˆ—è¡¨ |
| æ·»åŠ åŠ¨æ¼« | ä» TMDB æ·»åŠ  | æˆåŠŸåˆ›å»ºåŠ¨æ¼«è®°å½• |
| æ‰‹åŠ¨æ·»åŠ  | å¡«å†™è¡¨å•æ·»åŠ  | æˆåŠŸåˆ›å»ºå¹¶åˆå§‹åŒ–é›†æ•° |
| æŸ¥çœ‹è§†é¢‘æº | ç‚¹å‡»é›†æ•°æŸ¥çœ‹ | æ˜¾ç¤ºåŒ¹é…çš„è§†é¢‘æº |
| æ ‡è®°å·²çœ‹ | ç‚¹å‡»å·²çœ‹æŒ‰é’® | è¿›åº¦æ›´æ–° |
| åŒæ­¥åŠŸèƒ½ | è§¦å‘åŒæ­¥ | æ‰¾åˆ°æ–°çš„è§†é¢‘æº |
| æœç´¢è§„åˆ™ | è®¾ç½®é»‘/ç™½åå• | åŒ¹é…ç»“æœå—è§„åˆ™å½±å“ |

### 7.2 æ€§èƒ½æµ‹è¯•

#### å“åº”æ—¶é—´åŸºå‡†

| æ“ä½œ | é¢„æœŸæ—¶é—´ |
|------|----------|
| é¦–é¡µåŠ è½½ | < 500ms |
| åŠ¨æ¼«æœç´¢ | < 2s |
| è§†é¢‘æºæŸ¥æ‰¾ | < 5s |
| æ‰¹é‡åŒæ­¥ | å–å†³äºåŠ¨æ¼«æ•°é‡ |

---

## 8. ç»´æŠ¤é¡»çŸ¥

### 8.1 ç‰ˆæœ¬å‡çº§

```bash
# æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# é‡æ–°æ„å»º
docker-compose down
docker-compose up -d --build

# æ•°æ®åº“è¿ç§»ï¼ˆå¦‚æœ‰ï¼‰
# æ£€æŸ¥å¹¶æ‰§è¡Œè¿ç§»è„šæœ¬
```

### 8.2 å®šæœŸç»´æŠ¤ä»»åŠ¡

| ä»»åŠ¡ | é¢‘ç‡ | å‘½ä»¤ |
|------|------|------|
| æ•°æ®åº“å¤‡ä»½ | æ¯å¤© | cron job |
| æ¸…ç†è¿‡æœŸæ•°æ® | æ¯å‘¨ | æ‰‹åŠ¨æˆ–è„šæœ¬ |
| æ›´æ–°å›½æ¼«åˆ«å | æŒ‰éœ€ | ç¼–è¾‘ config.py |
| æ£€æŸ¥ Invidious å®ä¾‹ | æ¯æœˆ | æ›´æ¢ä¸å¯ç”¨å®ä¾‹ |

### 8.3 è´¡çŒ®æŒ‡å—

1. Fork é¡¹ç›®
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add some AmazingFeature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. å¼€å¯ Pull Request

### 8.4 è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ - è¯¦è§ LICENSE æ–‡ä»¶

---

## é™„å½•

### A. å¸¸ç”¨ Invidious å®ä¾‹

```
https://invidious.snopyta.org
https://yewtu.be
https://invidious.kavin.rocks
```

### B. TMDB ç±»å‹ ID

- åŠ¨æ¼«: `type=2` æˆ– `with_genres=16` (Animation)

### C. æ•°æ®åº“æŸ¥è¯¢ç¤ºä¾‹

```sql
-- æŸ¥è¯¢æ‰€æœ‰åŠ¨æ¼«åŠæœªçœ‹é›†æ•°
SELECT a.title_cn,
       (SELECT COUNT(*) FROM episodes e WHERE e.anime_id = a.id AND e.watched = 0) as unwatched
FROM animes a;

-- æŸ¥è¯¢æœ€è¿‘çš„åŒæ­¥æ—¥å¿—
SELECT * FROM sync_logs ORDER BY created_at DESC LIMIT 20;

-- æŸ¥è¯¢æ²¡æœ‰è§†é¢‘æºçš„é›†æ•°
SELECT e.anime_id, e.absolute_num
FROM episodes e
LEFT JOIN sources s ON e.id = s.episode_id
WHERE s.id IS NULL;
```

### D. ç›¸å…³èµ„æº

- [Flask æ–‡æ¡£](https://flask.palletsprojects.com/)
- [TMDB API æ–‡æ¡£](https://developers.themoviedb.org/)
- [Invidious æ–‡æ¡£](https://docs.invidious.io/)
- [APScheduler æ–‡æ¡£](https://apscheduler.readthedocs.io/)

---

**æ–‡æ¡£ç»“æŸ**

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·æäº¤ Issue æˆ– Pull Requestã€‚
