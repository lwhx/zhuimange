{% extends "base.html" %}
{% block title %}è¿½æ¼«é˜ - é¦–é¡µ{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-header__title">æˆ‘çš„è¿½æ›´</h1>
    <p class="page-header__subtitle">å…± {{ animes|length }} éƒ¨åŠ¨æ¼«</p>
</div>

<!-- æœç´¢æ¡† -->
<div class="search-box">
    <span class="search-box__icon">ğŸ”</span>
    <input type="text" id="search-input" class="search-box__input" placeholder="æœç´¢ TMDB åŠ¨æ¼«å¹¶æ·»åŠ ..." autocomplete="off">
    <button id="search-clear" class="search-box__clear">&times;</button>
    <div id="search-results" class="search-results"></div>
</div>

<!-- æ‰‹åŠ¨æ·»åŠ æŒ‰é’® -->
<div style="margin-bottom: 24px;">
    <button class="btn btn--secondary btn--sm" onclick="toggleManualAdd()">
        âœï¸ æ‰‹åŠ¨æ·»åŠ åŠ¨æ¼«
    </button>
</div>

<!-- æ‰‹åŠ¨æ·»åŠ è¡¨å• -->
<div id="manual-add-form" class="manual-add-form">
    <h3 style="margin-bottom:16px;font-size:1.05rem;">æ‰‹åŠ¨æ·»åŠ åŠ¨æ¼«</h3>
    <div class="form-group">
        <label>åŠ¨æ¼«åç§° *</label>
        <input type="text" id="manual-title" placeholder="ä¾‹: æ–—ç ´è‹ç©¹">
    </div>
    <div class="form-group">
        <label>æ€»é›†æ•°</label>
        <input type="number" id="manual-total-ep" placeholder="ä¾‹: 24" min="0">
    </div>
    <div class="form-group">
        <label>åˆ«åï¼ˆé€—å·åˆ†éš”ï¼‰</label>
        <input type="text" id="manual-aliases" placeholder="ä¾‹: BTTH, Battle Through the Heavens">
    </div>
    <div style="display:flex;gap:8px;">
        <button class="btn btn--primary btn--sm" onclick="submitManualAdd()">æ·»åŠ </button>
        <button class="btn btn--secondary btn--sm" onclick="toggleManualAdd()">å–æ¶ˆ</button>
    </div>
</div>

<!-- ç­›é€‰æ ‡ç­¾ -->
{% if animes|length > 0 %}
<div class="filter-tabs">
    <button class="filter-tab active" onclick="filterAnimes('all')">å…¨éƒ¨</button>
    <button class="filter-tab" onclick="filterAnimes('airing')">è¿è½½ä¸­</button>
    <button class="filter-tab" onclick="filterAnimes('ended')">å·²å®Œç»“</button>
    <button class="filter-tab" onclick="filterAnimes('unwatched')">æœ‰æ›´æ–°</button>
</div>
{% endif %}

<!-- åŠ¨æ¼«å¡ç‰‡ç½‘æ ¼ -->
{% if animes|length > 0 %}
<div class="anime-grid">
    {% for anime in animes %}
    <a href="/anime/{{ anime.id }}" class="anime-card" data-status="{{ anime.status }}"
        data-unwatched="{{ anime.unwatched_count }}">
        <div class="anime-card__poster-wrap">
            {% if anime.poster_url %}
            <img class="anime-card__poster" src="{{ anime.poster_url }}" alt="{{ anime.title_cn }}" loading="lazy"
                onerror="this.style.display='none'">
            {% endif %}

            {% if anime.unwatched_count > 0 %}
            <span class="anime-card__badge anime-card__badge--new">{{ anime.unwatched_count }}é›†æ›´æ–°</span>
            {% elif anime.status == 'Returning Series' %}
            <span class="anime-card__badge anime-card__badge--airing">è¿è½½ä¸­</span>
            {% elif anime.status == 'Ended' %}
            <span class="anime-card__badge anime-card__badge--ended">å·²å®Œç»“</span>
            {% endif %}
        </div>
        <div class="anime-card__body">
            <div class="anime-card__title" title="{{ anime.title_cn }}">{{ anime.title_cn }}</div>
            <div class="anime-card__progress">
                <div class="anime-card__progress-bar">
                    <div class="anime-card__progress-fill"
                        style="width: {{ ((anime.watched_ep or 0) / (anime.episode_count or 1) * 100)|int }}%"></div>
                </div>
                <span class="anime-card__progress-text">{{ anime.watched_ep or 0 }}/{{ anime.episode_count or
                    anime.total_episodes or '?' }}</span>
            </div>
        </div>
    </a>
    {% endfor %}
</div>
{% else %}
<div class="empty-state">
    <div class="empty-state__icon">ğŸ“º</div>
    <div class="empty-state__title">è¿˜æ²¡æœ‰è¿½æ›´çš„åŠ¨æ¼«</div>
    <div class="empty-state__desc">ä½¿ç”¨ä¸Šæ–¹æœç´¢æ¡†ä» TMDB æœç´¢å¹¶æ·»åŠ ä½ å–œæ¬¢çš„å›½æ¼«</div>
</div>
{% endif %}
{% endblock %}