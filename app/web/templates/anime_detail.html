{% extends "base.html" %}
{% block title %}{{ anime.title_cn }} - è¿½æ¼«é˜{% endblock %}

{% block content %}
<!-- é¢åŒ…å±‘ -->
<div style="margin-bottom: 20px;">
    <a href="/" style="color:var(--text-muted);font-size:0.85rem;">â† è¿”å›é¦–é¡µ</a>
</div>

<!-- åŠ¨æ¼«ä¿¡æ¯ -->
<div class="anime-detail">
    <div class="anime-detail__poster">
        {% if anime.poster_url %}
        <img src="{{ anime.poster_url }}" alt="{{ anime.title_cn }}">
        {% else %}
        <div
            style="width:100%;aspect-ratio:2/3;background:var(--bg-tertiary);display:flex;align-items:center;justify-content:center;font-size:3rem;">
            ğŸ¬</div>
        {% endif %}
    </div>

    <div class="anime-detail__info">
        <h1 class="anime-detail__title">{{ anime.title_cn }}</h1>

        {% if anime.title_en %}
        <div style="color:var(--text-muted);font-size:0.9rem;margin-top:-8px;">{{ anime.title_en }}</div>
        {% endif %}

        <div class="anime-detail__meta">
            <div class="anime-detail__meta-item">
                ğŸ“… <span>{{ anime.air_date or 'æœªçŸ¥' }}</span>
            </div>
            <div class="anime-detail__meta-item">
                ğŸ“º <span><strong>{{ anime.episodes|length }}</strong> é›†</span>
            </div>
            <div class="anime-detail__meta-item">
                ğŸ‘ï¸ <span>å·²çœ‹ <strong id="progress-text">{{ anime.watched_ep or 0 }}/{{ anime.episodes|length
                        }}</strong></span>
            </div>
            <div class="anime-detail__meta-item">
                {% if anime.status == 'Returning Series' %}
                ğŸŸ¢ è¿è½½ä¸­
                {% elif anime.status == 'Ended' %}
                ğŸ”´ å·²å®Œç»“
                {% else %}
                âšª {{ anime.status }}
                {% endif %}
            </div>
        </div>

        <!-- è¿›åº¦æ¡ -->
        <div style="margin-top:4px;">
            <div class="anime-card__progress-bar" style="height:6px;">
                <div class="anime-card__progress-fill" id="progress-fill"
                    style="width: {{ ((anime.watched_ep or 0) / (anime.episodes|length or 1) * 100)|int }}%"></div>
            </div>
        </div>

        {% if anime.overview %}
        <p class="anime-detail__overview">{{ anime.overview }}</p>
        {% endif %}

        <!-- åˆ«å -->
        {% if anime.aliases %}
        <div style="display:flex;flex-wrap:wrap;gap:6px;">
            {% for alias in anime.aliases %}
            <span
                style="padding:3px 10px;background:var(--bg-input);border-radius:var(--radius-xl);font-size:0.78rem;color:var(--text-muted);">{{
                alias }}</span>
            {% endfor %}
        </div>
        {% endif %}

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="anime-detail__actions">
            <button class="btn btn--primary btn--sm" id="sync-btn" onclick="syncAnime({{ anime.id }})">ğŸ”„ åŒæ­¥è§†é¢‘æº</button>
            <!-- åŒæ­¥è¿›åº¦æ¡ -->
            <div id="sync-progress" style="display:none;flex:1;min-width:200px;">
                <div style="display:flex;align-items:center;gap:8px;">
                    <div class="anime-card__progress-bar" style="flex:1;height:6px;">
                        <div id="sync-progress-fill" class="anime-card__progress-fill"
                            style="width:0%;transition:width 0.3s;"></div>
                    </div>
                    <span id="sync-progress-text"
                        style="font-size:0.78rem;color:var(--text-muted);white-space:nowrap;">0/0</span>
                </div>
            </div>
            <button class="btn btn--secondary btn--sm"
                onclick="document.getElementById('progress-section').classList.toggle('visible')">ğŸ“Š æ›´æ–°è¿›åº¦</button>
            <button class="btn btn--secondary btn--sm"
                onclick="document.getElementById('rules-section').classList.toggle('visible')">âš™ï¸ æœç´¢è§„åˆ™</button>
            <button class="btn btn--secondary btn--sm"
                onclick="document.getElementById('alias-section').classList.toggle('visible')">ğŸ·ï¸ ç®¡ç†åˆ«å</button>
            <button class="btn btn--danger btn--sm" onclick="deleteAnime({{ anime.id }})">ğŸ—‘ï¸ åˆ é™¤</button>
        </div>

        <!-- å¿«é€Ÿæ›´æ–°è¿›åº¦ -->
        <div id="progress-section" class="manual-add-form" style="margin-top:0;">
            <div style="display:flex;gap:8px;align-items:center;">
                <label style="white-space:nowrap;font-size:0.85rem;color:var(--text-secondary);">çœ‹åˆ°ç¬¬</label>
                <input type="number" id="progress-input" value="{{ anime.watched_ep or 0 }}" min="0"
                    max="{{ anime.episodes|length }}"
                    style="width:80px;padding:8px;background:var(--bg-input);border:1px solid var(--border-color);border-radius:var(--radius-sm);color:var(--text-primary);">
                <label style="white-space:nowrap;font-size:0.85rem;color:var(--text-secondary);">é›†</label>
                <button class="btn btn--primary btn--sm" onclick="updateProgress({{ anime.id }})">æ›´æ–°</button>
            </div>
        </div>

        <!-- æœç´¢è§„åˆ™ -->
        <div id="rules-section" class="manual-add-form" style="margin-top:0;">
            <h4 style="margin-bottom:12px;font-size:0.95rem;">æœç´¢è§„åˆ™</h4>
            <div class="form-group">
                <label>å…è®¸å…³é”®è¯ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
                <input type="text" id="rule-allow-keywords"
                    value="{{ (anime.rules.allow_keywords if anime.rules else '')|replace('[', '')|replace(']', '')|replace('\"', '') }}"
                       placeholder="ä¾‹: å®˜æ–¹, æ­£ç‰ˆ">
            </div>
            <div class="form-group">
                <label>å±è”½å…³é”®è¯ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
                <input type="text" id="rule-deny-keywords"
                       value="{{ (anime.rules.deny_keywords if anime.rules else '')|replace(' [', '' )|replace(']', ''
                    )|replace('\"', '' ) }}" placeholder="ä¾‹: å‰ªè¾‘, è§£è¯´">
            </div>
            <div class="form-group">
                <label>å…è®¸é¢‘é“ IDï¼ˆé€—å·åˆ†éš”ï¼‰</label>
                <input type="text" id="rule-allow-channels"
                    value="{{ (anime.rules.allow_channels if anime.rules else '')|replace('[', '')|replace(']', '')|replace('\"', '') }}">
            </div>
            <div class="form-group">
                <label>å±è”½é¢‘é“ IDï¼ˆé€—å·åˆ†éš”ï¼‰</label>
                <input type="text" id="rule-deny-channels"
                       value="{{ (anime.rules.deny_channels if anime.rules else '')|replace(' [', '' )|replace(']', ''
                    )|replace('\"', '' ) }}">
            </div>
            <button class="btn btn--primary btn--sm" onclick="saveRules({{ anime.id }})">ä¿å­˜è§„åˆ™</button>
        </div>

        <!-- åˆ«åç®¡ç† -->
        <div id="alias-section" class="manual-add-form" style="margin-top:0;">
            <div style="display:flex;gap:8px;align-items:center;">
                <input type="text" id="alias-input" placeholder="è¾“å…¥æ–°åˆ«å"
                    style="flex:1;padding:8px;background:var(--bg-input);border:1px solid var(--border-color);border-radius:var(--radius-sm);color:var(--text-primary);">
                <button class="btn btn--primary btn--sm" onclick="addAlias({{ anime.id }})">æ·»åŠ </button>
            </div>
        </div>
    </div>
</div>

<!-- é›†æ•°åˆ—è¡¨ -->
<div class="episodes-section">
    <div class="episodes-section__header">
        <h2 class="episodes-section__title">é›†æ•°åˆ—è¡¨</h2>
        <div style="display:flex;align-items:center;gap:12px;">
            <span style="color:var(--text-muted);font-size:0.85rem;">
                {{ anime.unwatched_count }} é›†æœªçœ‹
            </span>
            <button class="btn btn--secondary btn--sm" id="sort-toggle-btn" onclick="toggleEpisodeSort()" title="åˆ‡æ¢æ’åº">
                {% if anime.sort_order == 'desc' %}â†“ å€’åº{% else %}â†‘ æ­£åº{% endif %}
            </button>
        </div>
    </div>

    {% if anime.episodes|length > 0 %}
    <div class="episodes-grid">
        {% for ep in anime.episodes %}
        <div class="episode-item {% if ep.watched %}episode-item--watched{% endif %}" data-ep="{{ ep.absolute_num }}">
            <div class="episode-item__num">
                {% if ep.watched %}âœ“{% else %}{{ ep.absolute_num }}{% endif %}
            </div>
            <div class="episode-item__info">
                <div class="episode-item__title">
                    {% if ep.title %}{{ ep.title }}{% else %}ç¬¬{{ ep.absolute_num }}é›†{% endif %}
                </div>
                <div class="episode-item__date">
                    {% if ep.air_date %}{{ ep.air_date }}{% endif %}
                    {% if ep.source_count > 0 %}
                    Â· {{ ep.source_count }} ä¸ªè§†é¢‘æº
                    {% endif %}
                </div>
            </div>
            <div class="episode-item__actions">
                <button class="btn btn--sm btn--secondary"
                    onclick="openSourcesModal({{ anime.id }}, {{ ep.absolute_num }})" title="æŸ¥çœ‹è§†é¢‘æº">
                    ğŸ¬
                </button>
                {% if ep.watched %}
                <button class="btn btn--sm btn--secondary"
                    onclick="markUnwatched({{ anime.id }}, {{ ep.absolute_num }})" title="æ ‡è®°æœªçœ‹">
                    â†©ï¸
                </button>
                {% else %}
                <button class="btn btn--sm btn--success" onclick="markWatched({{ anime.id }}, {{ ep.absolute_num }})"
                    title="æ ‡è®°å·²çœ‹">
                    âœ“
                </button>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-state__icon">ğŸ“‹</div>
        <div class="empty-state__title">æš‚æ— é›†æ•°ä¿¡æ¯</div>
        <div class="empty-state__desc">å°è¯•åŒæ­¥è§†é¢‘æºä»¥è·å–é›†æ•°æ•°æ®</div>
    </div>
    {% endif %}
</div>
{% endblock %}